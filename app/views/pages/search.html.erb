<main>
  <!-- Map -->
  <section class="container">
   <div id="map" style='width: 800px; height: 500px;'></div>
   </section>
   <!-- End Map -->
   <!-- Search results -->
   <section class="container">
   <ol class="search_results">
     <% @search.each do |restaurant| %>
     <li class="search_result">
      <div class="restaurant_info">
        <h2><%= link_to restaurant.name, restaurant_path(restaurant.id) %></h2>
        <div>
          <% restaurant.categories.map(&:name).each do |category| %>
          <span><%= link_to category, search_path({restaurant: {name: category}}) %>, </span>
          <% end %>
        </div>
        <div>__ miles away</div>
        <% if total_ratings(restaurant.reviews) > 0 %>
          <div>Overall Rating: <%= average_rating(sum_of_ratings(restaurant.reviews), total_ratings(restaurant.reviews))  %> (<%= restaurant.reviews.count %> reviews)</div>
        <% end %>
       <div><%= restaurant.address %></div>
       <div><%= restaurant.phone_number %></div>
       </div>

       <% if restaurant.reviews.tag_counts.count > 0 %>
       <div class="card">
         <div class="card-body">
           <h5 class="card-title">What users said about this location...</h5>
           <ul class="tag_list">
             <% tag_cloud restaurant.reviews.tag_counts, [] do |tag, _| %>
             <li class="tag_item"><%= tag.name %></li>
             <% end %>
           </ul>
         </div>
       </div>
       <% end %>
     </li>
     <% end %>
   </ol>
   </section>
   <!-- End Search Results -->
</main>
<script defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>
<script>
  // Attach your callback function to the `window` object
  window.initMap = function() {
    // JS API is loaded and available
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 4,
      center: { lat: 37.0902, lng: -95.7129},
    });
    const geocoder = new google.maps.Geocoder();
    const addresses = <%= raw(@search.to_json) %>;

    addresses.forEach(function(address) {
      geocodeAddress(geocoder, map, address);
    });
  };

  function geocodeAddress(geocoder, resultsMap, address) {
    geocoder.geocode({ address: address.address }, (results, status) => {
      if (status === "OK") {
        resultsMap.setCenter(results[0].geometry.location);
        const marker = new google.maps.Marker({
          map: resultsMap,
          position: results[0].geometry.location,
        });

        const infowindow = new google.maps.InfoWindow({
          content: `${address.name} : ${address.address}`,
        });

        marker.addListener("click", () => {
          infowindow.open(map, marker);
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }
</script>
